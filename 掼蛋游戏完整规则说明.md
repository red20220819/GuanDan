# 掼蛋游戏完整规则说明

## 一、基本规则

### 牌组配置
- 使用两副完整扑克牌（108张）
- 每位玩家27张牌
- 4名玩家，固定搭档（南北vs东西）

### 级牌与逢人配
- 当前级数的红桃牌为"逢人配"（万能牌）
- 例如：2级时红桃2为逢人配，可以替代任意牌
- 逢人配在组合牌型中不算点数

### 牌的大小顺序
**重要说明**：掼蛋规则中，A是最大的普通牌，2是最小的
- A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2
- 特殊牌：级牌 > A，小王 > 级牌，大王 > 小王

### 升级规则
游戏结束时，根据玩家完成顺序（头游、二游、三游、末游）判定胜负：
- **头游+二游**：胜方升3级
- **头游+三游**：胜方升2级
- **头游+末游**：胜方升1级
- 负方不升级
- 从2级开始，打过A（14级）获胜

### 队伍配置
- **A队**：南家(玩家) + 北家(AI)
- **B队**：东家(AI) + 西家(AI)

## 二、牌型定义

### 基础牌型
1. **单张**：任意单牌
2. **对子**：两张相同点数的牌
3. **三张**：三张相同点数的牌
4. **三带二**：三张相同点数 + 一对对子
   - 注意：没有"三带一"，三张只能带对子

### 连续牌型
1. **顺子**：5张及以上连续单牌（不能包含2和王牌）
2. **连对**：3对及以上连续对子（如334455）
3. **钢板**：2个及以上连续三张（如333444）

### 炸弹（特殊牌型）
按大小顺序：
1. **天王炸弹**（最大）：4张王牌（大小王各2张）
2. **八炸**：8张相同点数
3. **七炸**：7张相同点数
4. **六炸**：6张相同点数
5. **同花顺**：5张以上同花色连续牌
6. **五炸**：5张相同点数
7. **四炸**：4张相同点数

## 三、游戏流程

### 轮次管理规则（核心规则）

#### 轮次的定义
从首家出牌开始，到其余三家连续Pass为止，牌桌清空，该轮结束。

#### 过牌规则
- **一旦选择"过"（Pass），本回合内永久失去出牌权**
- 过牌后不能在本轮再次出牌
- 只有等本轮结束、牌桌清空后，新的下一轮开始，才能再次参与领出或跟牌

#### 示例场景
1. 南家出牌 → 西家过牌 → 北家过牌 → 东家出牌
   - 西家和北家已经过牌，本轮不能再出牌
2. 东家出牌后 → 轮回南家 → 南家可以再次出牌（因为还没过牌）
3. 如果南家也过牌 → 轮回到西家，但西家已过牌，不能出牌
4. 继续到北家和东家，如果都过牌 → 轮次结束，清空桌面
5. 新一轮开始，由最后出牌的东家先出，所有玩家重新获得出牌权

#### 实现要点
- 使用`roundPassedPlayers`集合记录本轮过牌的玩家
- 轮转时跳过已过牌的玩家
- 轮次结束时清空过牌记录

### 出牌规则
1. **相同牌型比较点数大小**
2. **炸弹可以打任何非炸弹牌型**
3. **炸弹之间按上述顺序比较大小**
4. **天王炸弹最大**

### 胜负判定
游戏结束时，按玩家完成顺序排名：头游、二游、三游、末游

**升级规则**：
- **头游+二游**：胜方升3级
- **头游+三游**：胜方升2级
- **头游+末游**：胜方升1级
- 负方不升级

### 游戏结束流程

#### 排名系统
1. **头游**：第一个出完所有牌的玩家
2. **二游**：第二个出完所有牌的玩家
3. **三游**：第三个出完所有牌的玩家
4. **末游**：最后一个出完所有牌的玩家

#### 胜负判定
- 只要头游产生，胜负立即锁定
- 根据头游队友的位置确定胜负组合
- 无"平局"概念

#### 下一局规则
- 负方不升级，下一副由末游先出牌
- 本副胜负确定后，所有牌作废，立即洗牌进入下一副

## 四、大小比较规则

### 1. 基本原则
- **牌型关**：必须"同型"或"炸弹"才能进入大小比较
- **同型定义**：type 字符串必须完全相等
- **炸弹特权**：炸弹可以打任何非炸弹牌型

### 2. 大小权重计算

#### 普通牌型（family='normal'）
1. **单张**：
   - 直接取点数权重
   - 大王：103
   - 小王：102
   - 级牌（逢人配）：101
   - A：14
   - K：13
   - ...
   - 2：2（重要修正：2是最小的）

2. **对子**：
   - 基础权重20 + 点数权重
   - **王对**（大王+小王）：20 + 103 = 123（最大对子）
   - AA：20 + 14 = 34
   - 其他对子：20 + 对应点数权重

3. **三张**：
   - 基础权重30 + 点数权重

4. **顺子/连对/钢板**：
   - 使用尾张点数 + 长度加权
   - 例如：34567（尾张7）> 23456（尾张6）
   - 相同尾张时，长度越长越大

#### 炸弹牌型（family='bomb'）
按张数从大到小排序：
1. **天王炸弹**（4张王牌） - 最大
2. **8炸**（8张同点数）
3. **7炸**（7张同点数）
4. **6炸**（6张同点数）
5. **同花顺**（5张及以上同花色连续）- 介于6炸和5炸之间
6. **5炸**（5张同点数）
7. **4炸**（4张同点数）

炸弹之间比较：
- 先按张数比较（8炸 > 7炸 > 6炸 > 5炸 > 4炸）
- 张数相同再比点数（4个K > 4个Q）

**重要说明**：同张数炸弹的点数比较顺序：
```
A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2
```

注意：虽然单张牌时2 > A，但在炸弹中2是最小的！这是掼蛋的特殊规则。

### 出牌验证流程

#### 两层校验：

##### 第一层：牌型关
```javascript
// 1. 获取牌型
const currentType = getCardType(cards);
const lastType = getCardType(lastCards);

// 2. 检查是否可以比较
if (currentType.family === 'bomb' && lastType.family !== 'bomb') {
    // 炸弹可以打任何非炸弹
    return true;
}
if (currentType.family !== 'bomb' && lastType.family === 'bomb') {
    // 非炸弹不能打炸弹
    return false;
}
if (currentType.type !== lastType.type) {
    // 必须同型（除了炸弹打非炸弹）
    return false;
}
```

##### 第二层：大小关
```javascript
// 同型时比较大小
if (currentType.family === 'bomb') {
    // 炸弹比较：先张数，后点数
    if (currentType.count !== lastType.count) {
        return currentType.count > lastType.count;
    }
    return currentType.weight > lastType.weight;
} else {
    // 普通牌型比较
    return currentType.weight > lastType.weight;
}
```

## 五、特殊情况

### 进贡还贡
- 末游玩家需向头游玩家进贡最大牌
- 头游玩家还贡一张不需要的牌给末游玩家
- 如果是双上，则不需要进贡还贡

### A级规则
- 打到A级时，必须打到A才升级
- 如果打A失败，退回本级的起始级数

### 重要说明
1. **掼蛋没有"火箭"牌型**（这是民间错误叫法）
2. **掼蛋没有"三带一"牌型**（三张只能带对子）
3. 逢人配可以替代任意牌，但在牌型中不算点数

## 六、技术实现

### 数据结构
```javascript
// 牌的数据结构示例
{
    rank: 'K',        // 点数：3-10, J, Q, K, A, 2, 小王, 大王
    suit: '♠',       // 花色：♠, ♥, ♣, ♦, joker
    isRed: false,     // 是否红色
    value: 13         // 权重值
}

// 逢人配标记
isLevelCard: true    // 是否为当前级数的红桃牌
```

### 关键检查点
1. JOKER的suit统一使用'joker'（小写）
2. 逢人配只在红桃中查找
3. 三带二必须验证是3张+1对
4. 顺子不能包含2和王牌
5. 所有牌型通过规则引擎验证

### 常见误区

#### ❌ 错误实现
1. 炸弹和普通牌型用同一套比较规则
2. 没有区分family（家族）
3. 同花顺没有作为炸弹处理
4. 2的权重计算错误（曾经认为2大于A）
5. 炸弹点数比较使用单张牌的权重（错误：4个2 > 4个A）
6. 未实现王对（大王+小王）的特殊处理

#### ✅ 正确实现
1. 严格区分炸弹家族和普通牌家族
2. 炸弹有独立的比较规则
3. 同花顺是炸弹，不是普通顺子
4. 2的权重是2，小于A（掼蛋规则中A最大）
5. 炸弹使用独立的点数权重（A=14, K=13, ..., 2=2）
6. 王对（大王+小王）被正确识别，权重高于AA

### 重要规则总结

#### 王的大小关系
- **单张**：大王 > 小王 > 级牌 > A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2
- **对子**：王对（大王+小王） > AA > KK > ... > 33
- **级牌说明**：级牌是当前打到的级别牌（比如打5时，任何5都大于A）
- **重要**：由于小王 > 级牌 > A，所以小王永远可以盖A
- **修正说明**：2在所有普通牌中是最小的，只大于（特殊情况下的）级牌

### 代码检查清单

#### RuleEngine.js 需要检查：
1. `getCardType` 方法返回的 type 和 family 是否正确
2. `canBeat` 方法是否实现两层校验
3. 炸弹权重 `bombWeights` 是否正确
4. 同花顺是否被识别为炸弹

#### index-modern.html 需要检查：
1. `findAllPossiblePlays` 是否查找所有牌型
2. 出牌验证是否使用正确的参数格式
3. JOKER 的 suit 是否统一为 'joker'

## 七、功能状态

### 已实现功能
1. ✓ 基本牌型识别和大小比较
2. ✓ 炸弹等级系统
3. ✓ 游戏结束和排名系统
4. ✓ 升级逻辑
5. ✓ 末游首出规则
6. ✓ 手牌排序功能（点数排序/牌型排序）
7. ✓ 轮次管理（过牌规则）
8. ✓ AI出牌逻辑

### 待实现功能
1. ⭕ 进贡还贡系统
2. ⭕ 抗贡判定
3. ⭕ 级牌显示
4. ⭕ 得分统计
5. ⭕ 回放功能

### 已知问题
1. AI出牌策略可以进一步优化
2. 需要添加更多音效和动画效果
3. 移动端适配需要优化

## 八、更新日志

### 2024-12-11
1. **修正牌的大小顺序**
   - 原规则：2 > A > K > Q...
   - 新规则：A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2
   - 原因：根据用户反馈，掼蛋规则中A是最大的普通牌

2. **更新升级规则**
   - 添加完整的胜负判定系统
   - 头游+二游：胜方升3级
   - 头游+三游：胜方升2级
   - 头游+末游：胜方升1级
   - 负方不升级

3. **完善游戏结束流程**
   - 添加排名系统说明（头游、二游、三游、末游）
   - 明确胜负立即锁定规则
   - 末游先出牌规则

4. **修复轮次管理问题**
   - 修正了过牌后的轮转逻辑
   - 解决了游戏卡死的问题

5. **文档整合**
   - 将三个规则文档整合为一个完整的权威文档
   - 统一了所有规则说明
   - 添加了完整的技术实现细节