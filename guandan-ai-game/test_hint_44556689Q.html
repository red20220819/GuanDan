<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>提示测试 - 44556689Q</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .card {
            display: inline-block;
            padding: 5px 10px;
            margin: 2px;
            background: white;
            border: 1px solid #333;
            border-radius: 4px;
            font-weight: bold;
        }
        .card.red { color: #dc143c; }
        .card.black { color: #000; }
        h2 { color: #1976D2; }
        .result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .result.success { background: #c8e6c9; color: #2e7d32; }
        .result.fail { background: #ffcdd2; color: #c62828; }
        .debug { background: #f5f5f5; padding: 15px; font-family: monospace; font-size: 12px; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>掼蛋提示功能测试</h1>
    <button onclick="runTest()">运行测试</button>

    <div id="output"></div>

    <script src="js/components/RuleEngine.js"></script>
    <script>
        const ruleEngine = new RuleEngine();
        ruleEngine.setLevel(2); // 打2级

        function createCard(rank, suit) {
            const card = { rank, suit };
            card.isRed = suit === '♥' || suit === '♦';
            return card;
        }

        function runTest() {
            const output = document.getElementById('output');
            output.innerHTML = '';

            // 测试场景：手牌 44556689Q，上家出5
            const handCards = [
                createCard('4', '♠'),
                createCard('4', '♥'),
                createCard('5', '♣'),
                createCard('5', '♦'),
                createCard('6', '♠'),
                createCard('6', '♥'),
                createCard('8', '♣'),
                createCard('9', '♦'),
                createCard('Q', '♠')
            ];

            const lastPlay = {
                cards: [createCard('5', '♠')]
            };

            // 期望结果：应该提示6（最小的能打过5的牌）
            const expectedRank = '6';

            // 执行测试
            let html = '<div class="test-box">';
            html += '<h2>测试场景：手牌 44556689Q，上家出5</h2>';
            html += '<div><strong>当前级别：</strong>2（2是级牌，权重101）</div>';
            html += '<div><strong>上家出牌：</strong>';
            lastPlay.cards.forEach(c => {
                html += `<span class="card ${c.isRed ? 'red' : 'black'}">${c.rank}${c.suit}</span>`;
            });
            html += '（权重：' + ruleEngine.getCardWeight(lastPlay.cards[0]) + '）</div>';

            html += '<div><strong>手牌：</strong>';
            handCards.forEach(c => {
                html += `<span class="card ${c.isRed ? 'red' : 'black'}">${c.rank}${c.suit}</span>`;
            });
            html += '</div>';

            // 排序手牌
            const sortedCards = [...handCards].sort((a, b) => {
                return ruleEngine.getCardWeight(a) - ruleEngine.getCardWeight(b);
            });

            html += '<div class="debug">';
            html += '<strong>手牌排序（按权重）：</strong><br>';
            sortedCards.forEach(c => {
                html += `${c.rank}${c.suit} = 权重${ruleEngine.getCardWeight(c)}  `;
            });
            html += '</div>';

            // 找最小能打过的单张（优先使用单牌）
            html += '<div class="debug">';
            html += '<strong>查找过程：</strong><br>';

            // 统计每个点数的牌数
            const rankCounts = {};
            handCards.forEach(card => {
                rankCounts[card.rank] = (rankCounts[card.rank] || 0) + 1;
            });

            // 分离单牌和组合牌
            const singleCards = [];
            const pairCards = [];
            handCards.forEach(card => {
                if (rankCounts[card.rank] === 1) {
                    singleCards.push(card);
                } else {
                    pairCards.push(card);
                }
            });

            html += `单牌（废牌）：${singleCards.map(c => c.rank).join(', ')}<br>`;
            html += `组合牌（可拆）：${pairCards.map(c => c.rank).join(', ')}<br>`;
            html += '<br>';

            let foundCard = null;

            // 先从单牌中找
            singleCards.sort((a, b) => ruleEngine.getCardWeight(a) - ruleEngine.getCardWeight(b));
            html += '<strong>步骤1：从单牌中查找</strong><br>';
            for (const card of singleCards) {
                const validation = ruleEngine.validatePlay([card], lastPlay, handCards);
                const cardWeight = ruleEngine.getCardWeight(card);
                const lastWeight = ruleEngine.getCardWeight(lastPlay.cards[0]);
                const canBeat = cardWeight > lastWeight;
                html += `  尝试 ${card.rank}${card.suit}（权重${cardWeight}）：`;
                html += `canBeat=${canBeat}, valid=${validation.valid}`;
                if (validation.valid && !foundCard) {
                    html += ` ✓ 找到！`;
                    foundCard = card;
                }
                html += '<br>';
            }

            // 如果单牌中没找到，再从组合牌中找
            if (!foundCard) {
                pairCards.sort((a, b) => ruleEngine.getCardWeight(a) - ruleEngine.getCardWeight(b));
                html += '<strong>步骤2：从组合牌中查找（拆对子）</strong><br>';
                for (const card of pairCards) {
                    const validation = ruleEngine.validatePlay([card], lastPlay, handCards);
                    const cardWeight = ruleEngine.getCardWeight(card);
                    const lastWeight = ruleEngine.getCardWeight(lastPlay.cards[0]);
                    const canBeat = cardWeight > lastWeight;
                    html += `  尝试 ${card.rank}${card.suit}（权重${cardWeight}）：`;
                    html += `canBeat=${canBeat}, valid=${validation.valid}`;
                    if (validation.valid && !foundCard) {
                        html += ` ✓ 找到！`;
                        foundCard = card;
                    }
                    html += '<br>';
                }
            }

            html += '</div>';

            // 显示结果
            html += '<div class="result">';
            if (foundCard) {
                if (foundCard.rank === expectedRank) {
                    html += '<span class="result success">✓ 测试通过！</span><br>';
                    html += `期望提示：${expectedRank}，实际提示：${foundCard.rank}`;
                } else {
                    html += '<span class="result fail">✗ 测试失败！</span><br>';
                    html += `期望提示：${expectedRank}，但实际提示了：${foundCard.rank}`;
                }
            } else {
                html += '<span class="result fail">✗ 测试失败！</span><br>';
                html += `期望提示：${expectedRank}，但没有找到任何能打过的牌`;
            }
            html += '</div>';

            html += '</div>';
            output.innerHTML = html;
        }
    </script>
</body>
</html>
