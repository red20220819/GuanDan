# 掼蛋游戏完整规则说明

## 一、基本规则

### 牌组配置
- 使用两副完整扑克牌（108张）
- 每位玩家27张牌
- 4名玩家，固定搭档（南北vs东西）

### 级牌与逢人配（万能牌）

#### 级牌定义
**级牌 = 当前正在打的级别点数**

- 级牌不是固定某一张牌，而是随升级每副都在变化
- 首副从2级开始 → 级牌 = 2
- 每打完一副按名次升级 → 级牌变成新级别
- 一直打到A（14级）→ 冲关成功即比赛结束

#### 逢人配（红桃级牌的特权）

**红桃级牌拥有"万能代牌"特权**

1. **生命周期**：
   - 2级时：红桃2是逢人配
   - 5级时：红桃5是逢人配
   - A级时：红桃A是逢人配

2. **特权说明**：
   - 红桃级牌可当任意牌使用（不含王）
   - 可参与组合：炸弹、同花顺、顺子、连对、钢板等
   - 当单张打出时仅视为该级牌本身，不再万能

3. **级牌大小关系**：
   ```
   大王 > 小王 > 级牌 > A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2
   ```
   - 级牌永远排在「小王之后、A之前」
   - 不受它原本点数影响
   - 权重固定为101

4. **代码常量示例**：
   ```javascript
   const LEVEL_VALUE = 14; // 当前打A
   const levelCard = {
       rank: LEVEL_VALUE,          // 点数
       isLevel: true,              // 级牌标记
       isJoker: false,
       logicValue: 101,            // 权重 > 大王(103)?? 不，是101
       isUniversal: suit === '♥',  // 红桃才有万能权
   };
   ```

5. **给GLM的口诀**：
   > "级牌 = 当前级别点数；红桃那一张是万能牌；权重101永远大于A；升到A后必须双上才过关。"

#### 级牌分类显示
- **普通级牌**（所有花色的当前级别牌）：♠2 ♥2 ♣2 ♦2（打2时）
  - 淡黄色背景，方便识别

- **逢人配**（红桃级牌）：♥2（打2时）
  - 淡黄色背景 + 左上角🔴红色圆圈（白色"配"字）+ 右下角"配"字
  - 具有万能代牌特权

### 牌的大小顺序
**重要说明**：掼蛋规则中，A是最大的普通牌，2是最小的

**完整大小关系**：
```
大王 > 小王 > 级牌 > A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2
```

**权重值**：
- 大王：103
- 小王：102
- 级牌：101（无论当前打什么级别，权重固定为101）
- A：14
- K：13
- ...
- 2：2（最小）

### 升级规则
游戏结束时，根据玩家完成顺序（头游、二游、三游、末游）判定胜负：
- **头游+二游**：胜方升3级
- **头游+三游**：胜方升2级
- **头游+末游**：胜方升1级
- 负方不升级
- 从2级开始，打过A（14级）获胜

### 队伍配置
- **A队**：南家(玩家) + 北家(AI)
- **B队**：东家(AI) + 西家(AI)

## 二、牌型定义

### 基础牌型
1. **单张**：任意单牌
   - 王牌特殊规则：1张王牌（无论大小王）作为单张出牌
2. **对子**：两张相同点数的牌
   - 王牌特殊规则：2张王牌（大王+小王）可以作为对子出牌，称为"王对"
3. **三张**：三张相同点数的牌
   - 王牌特殊规则：3张王牌（任意组合）可以作为三张出牌
4. **三带二**：三张相同点数 + 一对对子
   - 注意：没有"三带一"，三张只能带对子

#### 王牌特殊规则（更新）
| 王牌数量 | 牌型 | 说明 | 炸弹？ |
|----------|------|------|--------|
| 1张 | 单张 | 按普通单张处理，大王 > 小王 | ❌ |
| 2张 | 王对 | 任意两张王牌可组成王对 | ❌ |
| 3张 | 三张 | 三张相同点数，只能管三张的牌 | ❌ |
| 4张 | 天王炸弹 | 最大牌型，可以打任何牌 | ✅ |

### 连续牌型

#### 重要规则：级牌在连续牌型中的处理

**级牌（所有花色）可以参与天然连续牌型**：
- 级牌在顺子、连对、钢板中使用其**原始点数**
- 例如：打7时，45678910（7为级牌）是合法的天然顺子
- 例如：打5时，334455（5为级牌）是合法的天然连对

**逢人配（红桃级牌）的特殊规则**：
- 可以作为万能牌，替代任意牌（除2和王牌外）
- 但不能替代2和王牌

#### 1. 顺子
- **定义**：5张及以上连续单牌
- **限制**：不能包含2和王牌
- **级牌规则**：
  - 级牌可以参与天然顺子，使用其原始点数
  - 逢人配（红桃级牌）可代其他牌（但不能代2和王）
- **示例**：
  - 45678910（7为级牌）→ ✅ 合法天然顺子
  - 345678（5为级牌）→ ✅ 合法天然顺子
  - 56789（缺6，有红桃7逢人配）→ ✅ 可用逢人配代6

#### 2. 连对
- **定义**：3-5对连续对子（如334455、778899、1010JJQQ、QQKKAA）
- **限制**：最少3对（6张牌），最多5对（10张牌）
- **限制**：不能包含2和王牌
- **级牌规则**：
  - 级牌可以参与天然连对，使用其原始点数
  - 逢人配（红桃级牌）可代其他牌（但不能代2和王）
- **示例**：
  - 445566（5为级牌）→ ✅ 合法天然连对（3对）
  - 7788991010（8为级牌）→ ✅ 合法天然连对（4对）
  - QQKKAA（K为级牌）→ ✅ 合法天然连对（3对）
  - 33445566（缺3对，有红桃5逢人配）→ ✅ 可用逢人配代

#### 3. 钢板
- **定义**：2个及以上连续三张（如333444、444555666）
- **限制**：每个三张必须是相同点数的3张牌
- **级牌规则**：
  - 级牌可以参与天然钢板，使用其原始点数
  - 逢人配（红桃级牌）可代其他牌（但不能代2和王）
- **示例**：
  - 444555（5为级牌）→ ✅ 合法天然钢板
  - 333444555（4为级牌）→ ✅ 合法天然钢板

### 炸弹（特殊牌型）
按大小顺序：
1. **天王炸弹**（最大）：4张王牌（大小王各2张）
2. **八炸**：8张相同点数
3. **七炸**：7张相同点数
4. **六炸**：6张相同点数
5. **同花顺**：5张以上同花色连续牌
6. **五炸**：5张相同点数
7. **四炸**：4张相同点数

## 三、游戏流程

### 轮次管理规则（核心规则）

#### 轮次的定义
从首家出牌开始，到其余三家连续Pass为止，牌桌清空，该轮结束。

#### 过牌规则
- **一旦选择"过"（Pass），本回合内永久失去出牌权**
- 过牌后不能在本轮再次出牌
- 只有等本轮结束、牌桌清空后，新的下一轮开始，才能再次参与领出或跟牌

#### 示例场景
1. 南家出牌 → 西家过牌 → 北家过牌 → 东家出牌
   - 西家和北家已经过牌，本轮不能再出牌
2. 东家出牌后 → 轮回南家 → 南家可以再次出牌（因为还没过牌）
3. 如果南家也过牌 → 轮回到西家，但西家已过牌，不能出牌
4. 继续到北家和东家，如果都过牌 → 轮次结束，清空桌面
5. 新一轮开始，由最后出牌的东家先出，所有玩家重新获得出牌权

#### 实现要点
- 使用`roundPassedPlayers`集合记录本轮过牌的玩家
- 轮转时跳过已过牌的玩家
- 轮次结束时清空过牌记录

#### 接风规则（特殊轮次规则）
**定义**：当某人出完最后一张牌（成为头游/二游/三游）且无人接牌时，下一轮由其下家先出牌，而不是按常规顺时针轮转。

**触发条件**：
1. 必须「无人接牌」——即全场连续Pass直到末尾
2. 必须「出完手牌」——即该人成为本轮最后一个出牌者

**示例场景**：
| 玩家 | 出牌/Pass | 说明 |
| ------ | --------- | ---- |
| A | 出完最后1张 | A 成为本轮最后出牌者，手牌为0 |
| B | Pass | 无人接牌 |
| C | Pass | 无人接牌 |
| D | Pass | 无人接牌 |
| → **触发接风** | **下一轮由A的下家B先出** | 而不是A自己 |

**效果**：
- 头游玩家出完牌后，获得排名但失去下一轮出牌权
- 出牌权传给头游的下家（顺时针下一座位）

### 出牌规则
1. **相同牌型比较点数大小**
2. **炸弹可以打任何非炸弹牌型**
3. **炸弹之间按上述顺序比较大小**
4. **天王炸弹最大**

### 胜负判定
游戏结束时，按玩家完成顺序排名：头游、二游、三游、末游

**升级规则**：
- **头游+二游**：胜方升3级
- **头游+三游**：胜方升2级
- **头游+末游**：胜方升1级
- 负方不升级

### 游戏结束流程

#### 排名系统
1. **头游**：第一个出完所有牌的玩家
2. **二游**：第二个出完所有牌的玩家
3. **三游**：第三个出完所有牌的玩家
4. **末游**：最后一个出完所有牌的玩家

#### 胜负判定
- 只要头游产生，胜负立即锁定
- 根据头游队友的位置确定胜负组合
- 无"平局"概念

#### 下一局规则
- 负方不升级，下一副由末游先出牌
- 本副胜负确定后，所有牌作废，立即洗牌进入下一副

## 四、大小比较规则

### 1. 基本原则
- **牌型关**：必须"同型"或"炸弹"才能进入大小比较
- **同型定义**：type 字符串必须完全相等
- **炸弹特权**：炸弹可以打任何非炸弹牌型

### 2. 大小权重计算

#### 重要说明：级牌权重的两种使用方式

**级牌在不同场景下使用不同的权重**：

1. **同型比较场景**（单张、对子、三张、炸弹）：
   - 级牌使用权重 **101**
   - 级牌永远大于A（权重14）
   - 大小关系：大王(103) > 小王(102) > 级牌(101) > A(14) > K(13) > ... > 3 > 2

2. **连续牌型场景**（顺子、连对、钢板）：
   - 级牌使用其**原始点数**（3-14），不是权重101
   - 例如：打7时，级牌7按点数7计算，可以参与45678910顺子
   - 例如：打5时，级牌5按点数5计算，可以参与334455连对

#### 普通牌型（family='normal'）
1. **单张**：
   - 直接取点数权重
   - 大王：103
   - 小王：102
   - 级牌：101（当前级别的所有牌，如打2时♠2♥2♣2♦2都是级牌）
   - A：14
   - K：13
   - ...
   - 2：2（当不是级牌时，2是最小的普通牌）
   - **逢人配**：红桃级牌（如打2时的♥2），既是级牌也是万能牌

2. **对子**：
   - 基础权重20 + 点数权重
   - **王对**（大王+小王）：20 + 103 = 123（最大对子）
   - 级牌对子：20 + 101 = 121（大于AA对子）
   - AA：20 + 14 = 34
   - 其他对子：20 + 对应点数权重

3. **三张**：
   - 基础权重30 + 点数权重
   - 级牌三张：30 + 101 = 131（大于AAA三张）

4. **顺子/连对/钢板**：
   - 使用尾张点数 + 长度加权
   - 例如：34567（尾张7）> 23456（尾张6）
   - 相同尾张时，长度越长越大
   - **重要**：级牌在这些牌型中使用其**原始点数**（3-14），而非权重101
     - 例如：45678910（7为级牌）按7的点数计算，不是101
     - 例如：334455（5为级牌）按5的点数计算，不是101

#### 炸弹牌型（family='bomb'）
按张数从大到小排序：
1. **天王炸弹**（4张王牌） - 最大
2. **8炸**（8张同点数）
3. **7炸**（7张同点数）
4. **6炸**（6张同点数）
5. **同花顺**（5张及以上同花色连续）- 介于6炸和5炸之间
6. **5炸**（5张同点数）
7. **4炸**（4张同点数）

炸弹之间比较：
- 先按张数比较（8炸 > 7炸 > 6炸 > 5炸 > 4炸）
- 张数相同再比点数（4个K > 4个Q）

**重要说明**：同张数炸弹的点数比较顺序：
```
A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2
```

注意：虽然单张牌时2 > A，但在炸弹中2是最小的！这是掼蛋的特殊规则。

### 出牌验证流程

#### 两层校验：

##### 第一层：牌型关
```javascript
// 1. 获取牌型
const currentType = getCardType(cards);
const lastType = getCardType(lastCards);

// 2. 检查是否可以比较
if (currentType.family === 'bomb' && lastType.family !== 'bomb') {
    // 炸弹可以打任何非炸弹
    return true;
}
if (currentType.family !== 'bomb' && lastType.family === 'bomb') {
    // 非炸弹不能打炸弹
    return false;
}
if (currentType.type !== lastType.type) {
    // 必须同型（除了炸弹打非炸弹）
    return false;
}
```

##### 第二层：大小关
```javascript
// 同型时比较大小
if (currentType.family === 'bomb') {
    // 炸弹比较：先张数，后点数
    if (currentType.count !== lastType.count) {
        return currentType.count > lastType.count;
    }
    return currentType.weight > lastType.weight;
} else {
    // 普通牌型比较
    return currentType.weight > lastType.weight;
}
```

## 五、特殊情况

### 进贡还贡系统（新增）

#### 触发条件
当双方队伍级差达到4级或以上时，落后方需要向领先方进贡

#### 进贡规则
- **单进贡**（级差4-7级）：落后方每人进贡1张牌
- **双进贡**（级差8级及以上）：落后方每人进贡2张牌

#### 进贡限制
- 不能进贡王牌（大王、小王）
- 不能进贡级牌
- 应进贡手中最大的牌

#### 还贡规则
- 领先方收到进贡后，必须还给进贡方一张牌
- 还牌应为手中最小的非王牌牌

### A级冲关规则（更新）

#### 冲关条件
- 当某队升到A级时，进入"冲关模式"
- 必须在当局完成"双上"（头游+二游）才算正式过A

#### 冲关结果
- **冲关成功**：双上（升3级）→ 正式过A，赢得整场比赛
- **冲关失败**：单上或平上 → 级数退回J，下一局从J重新开始

#### 特殊说明
- 到达A本身只是开始，需要通过A关才算获胜
- 打A失败后会保留冲关次数记录
- 先通过A关的队伍赢得整场比赛

### 重要说明
1. **掼蛋没有"火箭"牌型**（这是民间错误叫法）
2. **掼蛋没有"三带一"牌型**（三张只能带对子）
3. 逢人配可以替代任意牌，但在牌型中不算点数

## 六、技术实现

### 数据结构
```javascript
// 牌的数据结构示例
{
    rank: 'K',        // 点数：3-10, J, Q, K, A, 2, 小王, 大王
    suit: '♠',       // 花色：♠, ♥, ♣, ♦, joker
    isRed: false,     // 是否红色
    value: 13         // 权重值
}

// 逢人配标记
isLevelCard: true    // 是否为当前级数的红桃牌
```

### 关键检查点
1. JOKER的suit统一使用'joker'（小写）
2. 逢人配只在红桃中查找
3. 三带二必须验证是3张+1对
4. 顺子不能包含2和王牌
5. 所有牌型通过规则引擎验证

### 常见误区

#### ❌ 错误实现
1. 炸弹和普通牌型用同一套比较规则
2. 没有区分family（家族）
3. 同花顺没有作为炸弹处理
4. 2的权重计算错误（曾经认为2大于A）
5. 炸弹点数比较使用单张牌的权重（错误：4个2 > 4个A）
6. 未实现王对（大王+小王）的特殊处理

#### ✅ 正确实现
1. 严格区分炸弹家族和普通牌家族
2. 炸弹有独立的比较规则
3. 同花顺是炸弹，不是普通顺子
4. 2的权重是2，小于A（掼蛋规则中A最大）
5. 炸弹使用独立的点数权重（A=14, K=13, ..., 2=2）
6. 王对（大王+小王）被正确识别，权重高于AA

### 重要规则总结

#### 王的大小关系
- **单张**：大王(103) > 小王(102) > 级牌(101) > A(14) > K(13) > Q(12) > J(11) > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2
- **对子**：王对（大王+小王） > AA > KK > ... > 33
- **级牌说明**：级牌是当前打到的级别牌（如打2时，♠2♥2♣2♦2都是级牌，权重101）
- **逢人配**：红桃级牌（如打2时的♥2），既是级牌也是万能牌，可以替代任意牌
- **修正说明**：当2不是级牌时，2是最小的普通牌；当2是级牌时，2的权重是101，大于A

### 代码检查清单

#### RuleEngine.js 需要检查：
1. `getCardType` 方法返回的 type 和 family 是否正确
2. `canBeat` 方法是否实现两层校验
3. 炸弹权重 `bombWeights` 是否正确
4. 同花顺是否被识别为炸弹

#### index-modern.html 需要检查：
1. `findAllPossiblePlays` 是否查找所有牌型
2. 出牌验证是否使用正确的参数格式
3. JOKER 的 suit 是否统一为 'joker'

## 七、功能状态

### 已实现功能
1. ✓ 基本牌型识别和大小比较
2. ✓ 炸弹等级系统
3. ✓ 游戏结束和排名系统
4. ✓ 升级逻辑
5. ✓ 末游首出规则
6. ✓ 手牌排序功能（点数排序/牌型排序）
7. ✓ 轮次管理（过牌规则）
8. ✓ AI出牌逻辑
9. ✓ 王牌特殊规则（1-4张）
10. ✓ 进贡还贡系统
11. ✓ 抗贡判定（双王抗贡）
12. ✓ A级冲关规则
13. ✓ 级别显示UI组件
14. ✓ 接风规则（出完牌后由下家先出）
15. ✓ 排名图标显示（头游/二游/三游/末游）
16. ✓ 级牌权重修正（级牌=101，位于小王和A之间）
17. ✓ 逢人配功能（红桃级牌作为万能牌）
18. ✓ 倒计时自动出牌/过牌功能

### 待实现功能
1. ⭕ 得分统计
2. ⭕ 回放功能
3. ⭕ 音效和动画优化

### 已知问题
1. AI出牌策略可以进一步优化
2. 需要添加更多音效和动画效果
3. 移动端适配需要优化

## 八、更新日志

### 2024-12-11
1. **修正牌的大小顺序**
   - 原规则：2 > A > K > Q...
   - 新规则：A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2
   - 原因：根据用户反馈，掼蛋规则中A是最大的普通牌

2. **更新升级规则**
   - 添加完整的胜负判定系统
   - 头游+二游：胜方升3级
   - 头游+三游：胜方升2级
   - 头游+末游：胜方升1级
   - 负方不升级

3. **完善游戏结束流程**
   - 添加排名系统说明（头游、二游、三游、末游）
   - 明确胜负立即锁定规则
   - 末游先出牌规则

4. **修复轮次管理问题**
   - 修正了过牌后的轮转逻辑
   - 解决了游戏卡死的问题

5. **文档整合**
   - 将三个规则文档整合为一个完整的权威文档
   - 统一了所有规则说明
   - 添加了完整的技术实现细节