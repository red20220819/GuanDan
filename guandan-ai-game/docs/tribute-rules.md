# 掼蛋游戏进贡还贡规则文档

## 📋 概述

本文档详细描述了掼蛋游戏中的进贡还贡（简称"进贡"）系统的完整规则，包括触发条件、执行流程、边界条件和技术实现。

## 🎯 核心概念

### 基本定义
- **进贡**：落后方向领先方给出自己的最大牌
- **还贡**：领先方向进贡方还一张最小的牌（≤10）
- **抗贡**：末游玩家用双王免于进贡
- **级差**：两个队伍当前级数的差值

### 排名术语
- **头游**：第一个完成游戏的玩家
- **二游**：第二个完成游戏的玩家
- **三游**：第三个完成游戏的玩家
- **末游**：最后一个完成游戏的玩家

## 📜 完整规则

### 1. 触发条件

#### 1.1 基本条件
- ✅ 仅在**第二副及以后**的游戏中进贡，首副跳过
- ✅ 级差必须**≥4级**才需要进贡
- ✅ 必须有完整的玩家排名信息（头游、二游、三游、末游）

#### 1.2 级差判定
```
级差 0-3级：不进贡
级差 4-7级：单进贡
级差 8级及以上：双进贡
```

### 2. 进贡类型

#### 2.1 单下
- **定义**：只有一名末游玩家
- **执行**：末游向头游进贡1张最大的牌
- **示例**：A队2级 vs B队8级，末游向头游进贡1张牌

#### 2.2 双下
- **定义**：末游和三游同属一队
- **执行**：
  - 末游向头游进贡1张最大的牌
  - 三游向二游进贡1张最大的牌
- **示例**：A队2级 vs B队10级，末游→头游，三游→二游

### 3. 抗贡机制

#### 3.1 抗贡条件
- ✅ 末游玩家**持有双王**（大王+小王）
- ✅ 双下情况下，两名末游可分别抗贡

#### 3.2 抗贡效果
- 🚫 **无进贡**：抗贡方无需给出任何牌
- 🚫 **无还贡**：收贡方无需还牌
- ✅ **头游先出**：抗贡成功后，头游获得下一局先出权

### 4. 进贡牌限制

#### 4.1 禁止进贡的牌
- ❌ **王牌**：大王、小王
- ❌ **级牌**：当前级数的牌（如当前打8，则8为级牌）

#### 4.2 进贡牌要求
- ✅ 必须是手牌中**最大的牌**
- ✅ 优先选择非王牌、非级牌的大牌
- ✅ 按牌值大小：A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3

### 5. 还贡规则

#### 5.1 还贡牌要求
- ✅ 牌值**≤10**（3、4、5、6、7、8、9、10）
- ❌ 不能是王牌
- ❌ 不能是级牌
- ✅ 优先选择**最小的牌**

#### 5.2 还贡流程
1. 收贡方从手牌中选择符合条件的还贡牌
2. 如果没有≤10的牌，选择最小的非王牌
3. 如果只有王牌，选择小王
4. 还贡给对应的进贡方

### 6. 先出权规则

#### 6.1 正常进贡后
- ✅ **进贡者先出**：给出进贡牌的玩家获得下一局先出权

#### 6.2 抗贡后
- ✅ **头游先出**：原头游玩家维持先出权

## 🔄 执行流程

### 完整流程图
```
游戏结束 → 判断进贡条件 → [抗贡?] → [是: 头游先出] → [否: 进贡流程]
                                                    ↓
[进贡流程] → 选择进贡牌 → 给出进贡 → 选择还贡牌 → 给出还贡 → 进贡者先出
```

### 详细步骤

#### 步骤1：进贡检查
1. 检查是否首副游戏
2. 计算队伍级差
3. 判断单下vs双下
4. 检查抗贡条件
5. 构建进贡对子

#### 步骤2：抗贡处理
1. 检查末游手牌中的王牌数量
2. 双王则抗贡成功
3. 设置头游为先出玩家

#### 步骤3：正常进贡
1. 显示进贡UI（人类玩家）或自动选择（AI玩家）
2. 验证进贡牌合法性
3. 执行进贡牌转移
4. 选择还贡牌
5. 执行还贡牌转移
6. 设置进贡者为先出玩家

## 🎮 用户界面

### 进贡UI组件
- **TributePanel**：处理进贡牌选择
- **自动选择**：AI玩家自动选择最优进贡牌
- **实时验证**：即时检查选牌合法性
- **视觉反馈**：选中状态、错误提示

### 交互流程
1. **显示进贡面板**
2. **玩家选择进贡牌**
3. **系统验证合法性**
4. **确认进贡**
5. **自动处理还贡**
6. **开始新局**

## ⚙️ 技术实现

### 核心类

#### TributeSystem
```javascript
class TributeSystem {
    // 主要方法
    checkTributeNeeded(gameState)      // 检查进贡条件
    startTributeRound(tributeInfo)     // 开始进贡流程
    selectTributeCards(playerId, cards) // 选择进贡牌
    processReturnTributes(tributeInfo) // 处理还贡

    // 辅助方法
    checkAntiTribute(playerId)         // 检查抗贡
    validateTributeCards(cards)        // 验证进贡牌
    autoSelectTributeCards(playerId)   // AI自动选择
}
```

#### TributePanel
```javascript
class TributePanel {
    // UI方法
    show(tributePair, tributeInfo)     // 显示进贡面板
    hide()                             // 隐藏面板
    createCardElement(card)            // 创建牌元素

    // 交互方法
    onCardClick(card, element)         // 牌点击事件
    onConfirm()                        // 确认进贡
    onAutoSelect()                     // 自动选择
}
```

### 数据结构

#### 进贡信息对象
```javascript
{
    needsTribute: true,           // 是否需要进贡
    isDoubleTribute: false,       // 是否双进贡
    antiTribute: false,          // 是否抗贡
    levelDiff: 6,                // 级差
    currentLevel: '8',           // 当前级数
    playerRanks: [...],          // 玩家排名
    tributePairs: [              // 进贡对子
        {
            from: 'player4',     // 进贡方
            to: 'player1',       // 收贡方
            cardCount: 1         // 进贡张数
        }
    ],
    firstLead: 'player1'         // 先出玩家
}
```

## 🧪 测试用例

### 基础测试
1. **首副跳过**：首副游戏不应触发进贡
2. **级差不足**：级差<4级不应进贡
3. **单下进贡**：单个末游正确向头游进贡
4. **双下进贡**：末游→头游，三游→二游

### 边界测试
1. **抗贡成功**：双王免于进贡，头游先出
2. **进贡限制**：不能进贡王牌和级牌
3. **还贡限制**：只能还≤10的牌
4. **无牌可选**：特殊牌面情况处理

### 异常测试
1. **数据缺失**：缺少玩家排名或队伍信息
2. **手牌不足**：进贡方没有可进贡的牌
3. **还牌不足**：收贡方没有符合条件的还贡牌

## 📈 性能优化

### 计算优化
- 缓存级差计算结果
- 预筛选可进贡牌列表
- 批量处理AI进贡逻辑

### UI优化
- 延迟加载进贡面板
- 虚拟滚动大量手牌
- 动画性能优化

## 🔧 配置选项

### 可配置参数
```javascript
tributeConfig: {
    levelThreshold: 4,        // 进贡级差阈值
    doubleThreshold: 8,       // 双进贡级差阈值
    jokerAntiTribute: 2,      // 抗贡所需王牌数
    returnCardMaxValue: 10    // 还贡牌最大值
}
```

## 📋 版本历史

### v1.0.0 (当前版本)
- ✅ 实现完整进贡还贡规则
- ✅ 支持抗贡机制
- ✅ 完整UI交互
- ✅ AI自动进贡
- ✅ 全面测试覆盖

### 计划功能
- 🔄 进贡动画效果
- 🔄 历史记录查询
- 🔄 规则配置界面
- 🔄 多语言支持

## 🚀 部署说明

### 文件结构
```
js/
├── components/
│   └── TributeSystem.js     # 进贡系统核心逻辑
├── ui/
│   └── TributePanel.js      # 进贡UI组件
└── game/
    └── index-modern.html    # 主游戏文件

tests/
└── test-tribute-system.html # 进贡系统测试页面

docs/
└── tribute-rules.md         # 本规则文档
```

### 集成步骤
1. 引入`TributeSystem.js`和`TributePanel.js`
2. 在游戏引擎中初始化进贡系统
3. 在游戏结束时触发进贡检查
4. 处理进贡结果并开始新局

## 🤝 贡献指南

### 规则修改
- 修改规则需更新此文档
- 增加相应测试用例
- 更新UI提示信息

### 代码贡献
- 遵循现有代码风格
- 添加完整注释
- 包含错误处理

---

*最后更新：2024年12月21日*
*版本：v1.0.0*
*作者：Eason*