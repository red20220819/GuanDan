<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提示功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .test-case.pass {
            border-color: #4caf50;
            background: #f1f8f4;
        }
        .test-case.fail {
            border-color: #f44336;
            background: #fef1f1;
        }
        .cards {
            display: flex;
            gap: 5px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .card {
            padding: 5px 10px;
            background: white;
            border: 1px solid #333;
            border-radius: 4px;
            font-weight: bold;
        }
        .card.red { color: #dc143c; }
        .card.black { color: #000; }
        .card.joker { color: #ff6b6b; }
        .expected {
            color: #2196F3;
            font-weight: bold;
        }
        .actual {
            color: #ff9800;
            font-weight: bold;
        }
        button {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #1976D2;
        }
        #results {
            margin-top: 20px;
        }
        .summary {
            font-size: 18px;
            font-weight: bold;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>掼蛋提示功能测试</h1>
    <button onclick="runAllTests()">运行所有测试</button>
    <div id="results"></div>

    <script src="js/components/RuleEngine.js"></script>
    <script>
        // 创建测试用的规则引擎
        const ruleEngine = new RuleEngine();
        ruleEngine.setLevel(2); // 当前打2级

        // 模拟提示系统的核心逻辑
        function findSameTypeMinimal(lastPlay, handCards) {
            if (!lastPlay || !lastPlay.cards || lastPlay.cards.length === 0) {
                return null;
            }

            const lastType = ruleEngine.getCardType(lastPlay.cards);
            if (!lastType || lastType.type === 'invalid') {
                return null;
            }

            const validHints = [];

            if (lastType.type === 'single') {
                // 单张：找最小能打过的单张
                const sortedCards = [...handCards].sort((a, b) => {
                    const weightA = ruleEngine.getCardWeight(a);
                    const weightB = ruleEngine.getCardWeight(b);
                    return weightA - weightB;
                });

                for (const card of sortedCards) {
                    const validation = ruleEngine.validatePlay([card], lastPlay, handCards);
                    if (validation.valid && validation.type) {
                        return {
                            cards: [card],
                            type: validation.type,
                            description: `出单张 ${card.rank}${card.suit}`
                        };
                    }
                }
            }

            return validHints.length > 0 ? validHints[0] : null;
        }

        // 创建测试用牌
        function createCard(rank, suit) {
            const card = { rank, suit };
            if (suit === 'joker') {
                card.suit = 'joker';
                card.isRed = rank === '大王';
            } else {
                card.isRed = suit === '♥' || suit === '♦';
            }
            return card;
        }

        // 显示牌组
        function displayCards(cards) {
            return cards.map(c => {
                let cls = 'card';
                if (c.suit === 'joker') cls += ' joker';
                else if (c.isRed) cls += ' red';
                else cls += ' black';
                return `<span class="${cls}">${c.rank}${c.suit === 'joker' ? '' : c.suit}</span>`;
            }).join('');
        }

        // 运行单个测试
        function runTest(name, lastPlay, handCards, expectedCard) {
            const result = findSameTypeMinimal(lastPlay, handCards);
            const passed = expectedCard === null ?
                result === null :
                result !== null && result.cards[0].rank === expectedCard.rank;

            const testDiv = document.createElement('div');
            testDiv.className = `test-case ${passed ? 'pass' : 'fail'}`;

            let html = `
                <h3>${passed ? '✓' : '✗'} ${name}</h3>
                <div><strong>上家出牌：</strong>${displayCards(lastPlay.cards)}</div>
                <div><strong>手牌：</strong>${displayCards(handCards)}</div>
                <div><strong>期望提示：</strong><span class="expected">${expectedCard ? expectedCard.rank + expectedCard.suit : '无（过牌）'}</span></div>
                <div><strong>实际提示：</strong><span class="actual">${result ? result.cards[0].rank + result.cards[0].suit : '无'}</span></div>
            `;

            if (!passed) {
                html += `<div style="color: #d32f2f; margin-top: 10px;"><strong>失败原因：</strong>`;
                if (expectedCard === null) {
                    html += `应该返回null（过牌），但返回了 ${result ? result.description : 'null'}`;
                } else if (result === null) {
                    html += `应该提示 ${expectedCard.rank}${expectedCard.suit}，但返回了null`;
                } else {
                    html += `应该提示 ${expectedCard.rank}${expectedCard.suit}，但提示了 ${result.cards[0].rank}${result.cards[0].suit}`;
                }
                html += `</div>`;

                // 添加调试信息
                html += `<div style="background: #f5f5f5; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 12px;">`;
                html += `<strong>调试信息：</strong><br>`;
                html += `手牌排序（按权重）: `;
                const sortedCards = [...handCards].sort((a, b) => ruleEngine.getCardWeight(a) - ruleEngine.getCardWeight(b));
                html += sortedCards.map(c => `${c.rank}(权${ruleEngine.getCardWeight(c)})`).join(', ');
                html += `</div>`;
            }

            testDiv.innerHTML = html;
            return { element: testDiv, passed };
        }

        // 运行所有测试
        function runAllTests() {
            const results = document.getElementById('results');
            results.innerHTML = '';

            const tests = [];

            // 测试1: 上家出2（级牌），手牌有小王
            tests.push(runTest(
                '测试1: 上家出级牌2，手牌有小王（权102）',
                { cards: [createCard('2', '♠')] },
                [
                    createCard('6', '♠'), createCard('8', '♥'), createCard('Q', '♠'),
                    createCard('4', '♣'), createCard('4', '♦'), createCard('小王', 'joker')
                ],
                createCard('小王', 'joker')
            ));

            // 测试2: 上家出2（级牌），手牌无大牌
            tests.push(runTest(
                '测试2: 上家出级牌2，手牌都打不过',
                { cards: [createCard('2', '♠')] },
                [
                    createCard('6', '♠'), createCard('8', '♥'), createCard('Q', '♠'),
                    createCard('4', '♣'), createCard('4', '♦')
                ],
                null
            ));

            // 测试3: 上家出2（级牌），手牌有大王
            tests.push(runTest(
                '测试3: 上家出级牌2，手牌有大王（权103）',
                { cards: [createCard('2', '♠')] },
                [
                    createCard('6', '♠'), createCard('8', '♥'), createCard('大王', 'joker')
                ],
                createCard('大王', 'joker')
            ));

            // 测试4: 上家出2（级牌），手牌有级牌2♦
            tests.push(runTest(
                '测试4: 上家出级牌2♠，手牌有级牌2♦（同级牌不能打）',
                { cards: [createCard('2', '♠')] },
                [
                    createCard('6', '♠'), createCard('8', '♥'), createCard('2', '♦')
                ],
                null
            ));

            // 测试5: 上家出6，手牌有68Q
            tests.push(runTest(
                '测试5: 上家出6，手牌有68Q（应提示8）',
                { cards: [createCard('6', '♠')] },
                [
                    createCard('6', '♠'), createCard('8', '♥'), createCard('Q', '♠'),
                    createCard('4', '♣'), createCard('4', '♦')
                ],
                createCard('8', '♥')
            ));

            // 测试6: 上家出大王，手牌有小王
            tests.push(runTest(
                '测试6: 上家出大王（权103），手牌有小王（权102，打不过）',
                { cards: [createCard('大王', 'joker')] },
                [
                    createCard('小王', 'joker'), createCard('6', '♠'), createCard('8', '♥')
                ],
                null
            ));

            // 测试7: 上家出5，手牌有4445556677
            tests.push(runTest(
                '测试7: 上家出5，手牌有44556677（应提示6）',
                { cards: [createCard('5', '♠')] },
                [
                    createCard('4', '♣'), createCard('4', '♦'),
                    createCard('5', '♣'), createCard('5', '♦'),
                    createCard('6', '♣'), createCard('6', '♦'),
                    createCard('7', '♣'), createCard('7', '♦')
                ],
                createCard('6', '♣')
            ));

            // 测试8: 上家出K，手牌有AA
            tests.push(runTest(
                '测试8: 上家出K，手牌有AA（应提示A）',
                { cards: [createCard('K', '♠')] },
                [
                    createCard('A', '♣'), createCard('A', '♦'), createCard('Q', '♠')
                ],
                createCard('A', '♣')
            ));

            // 显示结果
            let passedCount = 0;
            tests.forEach(test => {
                results.appendChild(test.element);
                if (test.passed) passedCount++;
            });

            const summary = document.createElement('div');
            summary.className = 'summary';
            summary.innerHTML = `
                测试结果：${passedCount}/${tests.length} 通过
                ${passedCount === tests.length ? '✓ 所有测试通过！' : '✗ 有测试失败，请查看上面的详细信息'}
            `;
            results.insertBefore(summary, results.firstChild);
        }

        // 页面加载完成后自动运行测试
        window.onload = function() {
            console.log('测试页面已加载，点击"运行所有测试"按钮开始测试');
        };
    </script>
</body>
</html>
