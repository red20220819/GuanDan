# 掼蛋牌型大小规则详细说明

## 三、轮次管理规则（核心规则）

### 轮次的定义
从首家出牌开始，到其余三家连续Pass为止，牌桌清空，该轮结束。

### 过牌规则
- **一旦选择"过"（Pass），本回合内永久失去出牌权**
- 过牌后不能在本轮再次出牌
- 只有等本轮结束、牌桌清空后，新的下一轮开始，才能再次参与领出或跟牌

### 示例场景
1. 南家出牌 → 西家过牌 → 北家过牌 → 东家出牌
   - 西家和北家已经过牌，本轮不能再出牌
2. 东家出牌后 → 轮回南家 → 南家可以再次出牌（因为还没过牌）
3. 如果南家也过牌 → 轮回到西家，但西家已过牌，不能出牌
4. 继续到北家和东家，如果都过牌 → 轮次结束，清空桌面
5. 新一轮开始，由最后出牌的东家先出，所有玩家重新获得出牌权

### 实现要点
- 使用`roundPassedPlayers`集合记录本轮过牌的玩家
- 轮转时跳过已过牌的玩家
- 轮次结束时清空过牌记录

## 一、牌型定义（type）

1. **普通牌型**：
   - `single` - 单张
   - `pair` - 对子
   - `triple` - 三张
   - `tripleWithPair` - 三带二
   - `straight` - 顺子（5张及以上）
   - `pairStraight` - 连对（3对及以上）
   - `tripleStraight` - 钢板（2个及以上连续三张）

2. **炸弹牌型**：
   - `straightFlush` - 同花顺（5张及以上同花色连续）
   - `normalBomb` - 普通炸弹（4-8张同点数）
   - `kingBomb` - 天王炸弹（4张王牌）

## 二、牌型家族（family）

1. **`normal`** - 普通牌家族
   - 包含：单张、对子、三张、三带二、顺子、连对、钢板

2. **`bomb`** - 炸弹家族
   - 包含：同花顺、普通炸弹、天王炸弹

## 三、大小比较规则

### 1. 基本原则
- **牌型关**：必须"同型"或"炸弹"才能进入大小比较
- **同型定义**：type 字符串必须完全相等
- **炸弹特权**：炸弹可以打任何非炸弹牌型

### 2. 大小权重计算

#### 普通牌型（family='normal'）
1. **单张**：
   - 直接取点数权重
   - 大王：103
   - 小王：102
   - 级牌（逢人配）：101
   - A：14
   - K：13
   - ...
   - 2：15（注意：2大于A）

2. **对子**：
   - 基础权重20 + 点数权重
   - **王对**（大王+小王）：20 + 103 = 123（最大对子）
   - AA：20 + 14 = 34
   - 其他对子：20 + 对应点数权重

3. **三张**：
   - 基础权重30 + 点数权重

2. **顺子/连对/钢板**：
   - 使用尾张点数 + 长度加权
   - 例如：34567（尾张7）> 23456（尾张6）
   - 相同尾张时，长度越长越大

#### 炸弹牌型（family='bomb'）
按张数从大到小排序：
1. **天王炸弹**（4张王牌） - 最大
2. **8炸**（8张同点数）
3. **7炸**（7张同点数）
4. **6炸**（6张同点数）
5. **同花顺**（5张及以上同花色连续）- 介于6炸和5炸之间
6. **5炸**（5张同点数）
7. **4炸**（4张同点数）

炸弹之间比较：
- 先按张数比较（8炸 > 7炸 > 6炸 > 5炸 > 4炸）
- 张数相同再比点数（4个K > 4个Q）

**重要说明**：同张数炸弹的点数比较顺序：
```
A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3 > 2
```

注意：虽然单张牌时2 > A，但在炸弹中2是最小的！这是掼蛋的特殊规则。

## 四、出牌验证流程

### 两层校验：

#### 第一层：牌型关
```javascript
// 1. 获取牌型
const currentType = getCardType(cards);
const lastType = getCardType(lastCards);

// 2. 检查是否可以比较
if (currentType.family === 'bomb' && lastType.family !== 'bomb') {
    // 炸弹可以打任何非炸弹
    return true;
}
if (currentType.family !== 'bomb' && lastType.family === 'bomb') {
    // 非炸弹不能打炸弹
    return false;
}
if (currentType.type !== lastType.type) {
    // 必须同型（除了炸弹打非炸弹）
    return false;
}
```

#### 第二层：大小关
```javascript
// 同型时比较大小
if (currentType.family === 'bomb') {
    // 炸弹比较：先张数，后点数
    if (currentType.count !== lastType.count) {
        return currentType.count > lastType.count;
    }
    return currentType.weight > lastType.weight;
} else {
    // 普通牌型比较
    return currentType.weight > lastType.weight;
}
```

## 五、常见误区

### ❌ 错误实现
1. 炸弹和普通牌型用同一套比较规则
2. 没有区分family（家族）
3. 同花顺没有作为炸弹处理
4. 2的权重计算错误（应该大于A）
5. 炸弹点数比较使用单张牌的权重（错误：4个2 > 4个A）
6. 未实现王对（大王+小王）的特殊处理

### ✅ 正确实现
1. 严格区分炸弹家族和普通牌家族
2. 炸弹有独立的比较规则
3. 同花顺是炸弹，不是普通顺子
4. 2的权重是15，大于A的14（仅适用于单张牌）
5. 炸弹使用独立的点数权重（A=14, K=13, ..., 2=2）
6. 王对（大王+小王）被正确识别，权重高于AA

## 重要规则总结

### 王的大小关系
- **单张**：大王 > 小王 > 级牌 > A > K > ... > 3 > 2
- **对子**：王对（大王+小王） > AA > KK > ... > 33
- **级牌说明**：级牌是当前打到的级别牌（比如打5时，任何5都大于A）
- **重要**：由于小王 > 级牌 > A，所以小王永远可以盖A

## 六、代码检查清单

### RuleEngine.js 需要检查：
1. `getCardType` 方法返回的 type 和 family 是否正确
2. `canBeat` 方法是否实现两层校验
3. 炸弹权重 `bombWeights` 是否正确
4. 同花顺是否被识别为炸弹

### index-modern.html 需要检查：
1. `findAllPossiblePlays` 是否查找所有牌型
2. 出牌验证是否使用正确的参数格式
3. JOKER 的 suit 是否统一为 'joker'